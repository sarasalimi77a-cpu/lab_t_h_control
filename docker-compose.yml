services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: temp_hum_mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -h localhost -p 1883 -t '$$SYS/broker/uptime' -C 1 -W 15 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 5s
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  controller:
    build:
      context: .
      dockerfile: Dockerfile
    image: temp_hum_app
    container_name: temp_hum_controller
    restart: unless-stopped
    command: ["python", "-u", "-m", "controller.controller_api"]
    environment:
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - CONTROL_LOOP_SEC=5
      - MOCK_SENSORS=1
      - SIM_LOOP_SEC=10
      - LOG_DIR=/tmp/logs
    depends_on:
      mqtt:
        condition: service_healthy
    ports:
      - "8081:8081"
    volumes:
      - ./catalog:/app/catalog
      - ./controller:/app/controller
      - ./Device_connectors:/app/Device_connectors
      - ./simulators:/app/simulators
      - logsdata:/tmp/logs

  registry:
    image: temp_hum_app
    container_name: temp_hum_registry
    restart: unless-stopped
    command: ["python", "-u", "-m", "catalog_registry.registry_api"]
    environment:
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - REGISTRY_ENABLE_CONTROLLER=0
      - CONTROLLER_URL=http://controller:8081
      - LOG_DIR=/tmp/logs
    depends_on:
      controller:
        condition: service_started
    ports:
      - "8080:8080"
    volumes:
      - ./catalog:/app/catalog
      - ./catalog_registry:/app/catalog_registry
      - logsdata:/tmp/logs

  thingspeak:
    image: temp_hum_app
    container_name: temp_hum_thingspeak
    restart: unless-stopped
    command: ["python", "-u", "-m", "ThingSpeak.adaptor"]
    environment:
      - REGISTRY_API_URL=http://registry:8080
      - THINGSPEAK_API_KEY=${THINGSPEAK_API_KEY:-}
      - THINGSPEAK_LAB_ID=${THINGSPEAK_LAB_ID:-}
      - THINGSPEAK_POLL_SEC=${THINGSPEAK_POLL_SEC:-60}
    depends_on:
      registry:
        condition: service_started
    volumes:
      - ./ThingSpeak:/app/ThingSpeak
      - ./catalog:/app/catalog

  telegram_bot:
    image: temp_hum_app
    container_name: temp_hum_telegram
    restart: unless-stopped
    command: ["python", "-u", "-m", "User_awareness.telegram_bot"]
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - REGISTRY_API_URL=http://registry:8080

    depends_on:
      registry:
        condition: service_started
    volumes:
      - ./User_awareness:/app/User_awareness
      - ./catalog_registry:/app/catalog_registry
      - ./catalog:/app/catalog

  frontend:
    image: nginx:alpine
    container_name: temp_hum_frontend
    restart: unless-stopped
    depends_on:
      registry:
        condition: service_started
    ports:
      - "80:80"
    volumes:
      - ./frontEnd:/usr/share/nginx/html:ro

  sensor_logs:
    image: busybox:1.36
    container_name: temp_hum_sensor_logs
    restart: unless-stopped
    command: sh -c "touch /tmp/logs/sensors.log && tail -n+1 -f /tmp/logs/sensors.log"
    depends_on:
      controller:
        condition: service_started
    volumes:
      - logsdata:/tmp/logs

  actuator_logs:
    image: busybox:1.36
    container_name: temp_hum_actuator_logs
    restart: unless-stopped
    command: ["sh", "-c", "touch /tmp/logs/actuators.log && tail -n+1 -f /tmp/logs/actuators.log"]
    depends_on:
      controller:
        condition: service_started
    volumes:
      - logsdata:/tmp/logs

  logic_logs:
    image: busybox:1.36
    container_name: temp_hum_logic_logs
    restart: unless-stopped
    command: ["sh", "-c", "touch /tmp/logs/logic.log && tail -n+1 -f /tmp/logs/logic.log"]
    depends_on:
      controller:
        condition: service_started
    volumes:
      - logsdata:/tmp/logs

volumes:
  logsdata:
